pipeline {
    agent any
    
    environment {
        DOCKER_COMPOSE_FILE = "docker-compose.jenkins.yml"
    }
    
    stages {
        stage('Checkout Code') {
            steps {
                echo "Cloning project repository..."
                git branch: 'jenkins', url: 'https://github.com/Muhammad-Daud-0/Shop-Sphere.git'
            }
        }
        stage('Set Up Docker Environment') {
            steps {
                echo 'âš™ï¸ Checking Docker and Docker Compose installation...'
                sh '''
                    docker --version
                    if docker compose version >/dev/null 2>&1; then
                        echo "âœ… Docker Compose v2 detected"
                    else
                        echo "âš ï¸ Installing Docker Compose plugin..."
                        apt-get update -y && apt-get install -y docker-compose-plugin
                    fi
                    docker compose version
                '''
            }
        }
        
        stage('Clean Previous Containers') {
            steps {
                echo 'ğŸ§¹ Cleaning up old containers and volumes...'
                sh '''
                    echo "ğŸ” Removing existing CI containers if any..."
                    # ğŸ†• Added: remove any containers that have _ci in name
                    docker ps -aq --filter "name=_ci" | xargs -r docker rm -f || true

                    echo "ğŸ” Bringing down any docker-compose project..."
                    docker compose down --volumes --remove-orphans || true
                    
                    echo "ğŸ§¼ Pruning unused images, networks, and volumes..."
                    docker system prune -af || true
                    docker volume prune -f || true
                '''
            }
        }
        

        stage('Build and Run Application') {
            steps {
                echo 'ğŸš€ Building and starting containers...'
                sh '''
                    docker compose up -d --build
                '''
            }
        }
        
        stage('Verify Containers') {
            steps {
                echo 'ğŸ” Listing running containers...'
                sh 'docker ps'
            }
        }

        stage('Application Health Check') {
            steps {
                echo 'ğŸ©º Checking if backend and frontend are accessible...'
                sh '''
                    sleep 10
                    echo "Backend (port 3001):"
                    curl -I http://localhost:3001 || true
                    echo "Frontend (port 8081):"
                    curl -I http://localhost:8081 || true
                '''
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Build pipeline completed successfully! Containers are running.'
        }
        failure {
            echo 'âŒ Build pipeline failed. Please check the Jenkins logs for details.'
        }
    }
}
