pipeline {
    agent any

    triggers {
        githubPush()   
    }

    environment {
        COMPOSE_PROJECT_NAME = "jenkins_ci_app"
        VITE_API = "http://3.109.2.224:3000"   // ‚úÖ Inject your frontend API endpoint here
    }

    stages {
        stage('Checkout Code from GitHub') {
            steps {
                echo 'üì¶ Cloning repository...'
                git branch: 'jenkins', url: 'https://github.com/Muhammad-Daud-0/Shop-Sphere.git'
            }
        }

        stage('Set Up Docker Environment') {
            steps {
                echo '‚öôÔ∏è Checking Docker and Docker Compose installation...'
                sh '''
                    docker --version
                    if docker compose version >/dev/null 2>&1; then
                        echo "‚úÖ Docker Compose v2 detected"
                    else
                        echo "‚ö†Ô∏è Installing Docker Compose plugin..."
                        apt-get update -y && apt-get install -y docker-compose-plugin
                    fi
                    docker compose version
                '''
            }
        }

        stage('Clean Previous Containers') {
            steps {
                echo 'üßπ Cleaning up old containers and volumes...'
                sh '''
                    echo "üîç Removing existing CI containers if any..."
                    docker ps -aq --filter "name=_ci" | xargs -r docker rm -f || true

                    echo "üîç Bringing down any docker-compose project..."
                    docker compose down --volumes --remove-orphans || true

                    echo "üßº Pruning unused images, networks, and volumes..."
                    docker system prune -af || true
                    docker volume prune -f || true
                '''
            }
        }

        stage('Build and Run Application') {
            steps {
                echo 'üöÄ Building and starting containers (no cache)...'
                sh '''
                    # Export VITE_API so Docker sees it
                    export VITE_API=${VITE_API}

                    # Rebuild everything without cache to pick up new .env and environment vars
                    docker compose build --no-cache
                    docker compose up -d
                '''
            }
        }

        stage('Verify Containers') {
            steps {
                echo 'üîç Listing running containers...'
                sh 'docker ps'
            }
        }

        stage('Application Health Check') {
            steps {
                echo 'ü©∫ Checking if backend and frontend are accessible...'
                sh '''
                    echo "‚è≥ Waiting up to 60s for backend and frontend to respond..."
                    for i in {1..12}; do
                      if curl -s http://localhost:4000 >/dev/null 2>&1; then
                        echo "‚úÖ Backend is responding on port 4000"
                        break
                      else
                        echo "‚è≥ Waiting for backend... ($i/12)"
                        sleep 5
                      fi
                    done

                    for i in {1..12}; do
                      if curl -s http://localhost:8085 >/dev/null 2>&1; then
                        echo "‚úÖ Frontend is responding on port 8085"
                        break
                      else
                        echo "‚è≥ Waiting for frontend... ($i/12)"
                        sleep 5
                      fi
                    done

                    echo "üßæ Backend logs (last 20 lines):"
                    docker logs backend_ci --tail 20 || true

                    echo "üßæ Frontend logs (last 20 lines):"
                    docker logs frontend_ci --tail 20 || true
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ Build pipeline completed successfully! Website should be live on EC2.'
        }
        failure {
            echo '‚ùå Build pipeline failed. Check Jenkins logs for details.'
        }
    }
}